---
import Layout from '../components/layout/Layout.astro';
import RackShelf from '../components/issues/RackShelf.astro';
import IssueCoverCard from '../components/issues/IssueCoverCard.astro';
import { getCollection, getEntry } from 'astro:content';
import { getIssuesForPublication, getPostsForIssue, getLatestIssues } from '../lib/contentSource';
import { coverLinesFromPosts } from '../lib/lineup';

const publications = (await getCollection('publications')).filter((publication) => publication.data.isFeatured);

const shelves = await Promise.all(
  publications.map(async (publication) => {
    const issues = (await getIssuesForPublication(publication.id))
      .filter((issue: any) => issue.data.status === 'locked')
      .slice(0, 6);
    const items = await Promise.all(
      issues.map(async (issue: any) => {
        const posts = (await getPostsForIssue(publication.id, issue.data.issueSlug)) as any;
        return { issue, publication, coverLines: coverLinesFromPosts(posts as any, 6) };
      })
    );
    return { publication, items };
  })
);

const latestArrivals = await getLatestIssues(6);
const latestShelfItems = await Promise.all(
  latestArrivals.map(async (issue: any) => {
    const publication = await getEntry('publications', issue.data.publicationId);
    const posts = (await getPostsForIssue(issue.data.publicationId, issue.data.issueSlug)) as any;
    return { issue, publication: publication!, coverLines: coverLinesFromPosts(posts as any, 4) };
  })
);
---
<Layout title="Stackbound Press - Rack" heroFrame>
  <div class="space-y-12">
    <section class="rack-hero">
      <div class="rack-hero-inner">
        <div class="rack-header">
          <div>
            <div class="rack-eyebrow">Latest issues</div>
            <h1 class="rack-title">On the digital newsstand.</h1>
            <p class="rack-sub">
              Curated dev magazines, ready to read. Grab a cover, open the issue, dive into the lineup.
            </p>
          </div>
          <div class="flex flex-wrap gap-3">
            <a href="/issues" class="btn-link">Browse all</a>
            <a href="/archive" class="btn-link">Archive</a>
          </div>
        </div>
        <div class="rack-rail"></div>
        <div class="shelf-grid">
          {latestShelfItems.map((item) => (
            <IssueCoverCard issue={item.issue} publication={item.publication} coverLines={item.coverLines} showStatus />
          ))}
        </div>
        <div class="mt-4 flex justify-center">
          <a href="/issues" class="btn-link">View more</a>
        </div>
      </div>
    </section>

    <div class="feature-grid">
      <div class="feature-card">
        <div class="caps text-xs text-[var(--accent)]">Features</div>
        <h3 class="font-display text-2xl">Curated shelves</h3>
        <p class="text-sm text-[var(--muted)]">Explore detailed guides and opinionated issues from each masthead.</p>
      </div>
      <div class="feature-card">
        <div class="caps text-xs text-[var(--accent)]">Articles</div>
        <h3 class="font-display text-2xl">Fresh drops</h3>
        <p class="text-sm text-[var(--muted)]">Read the newest posts, routed straight from the CMS.</p>
      </div>
      <div class="feature-card">
        <div class="caps text-xs text-[var(--accent)]">Guides</div>
        <h3 class="font-display text-2xl">Hands-on learning</h3>
        <p class="text-sm text-[var(--muted)]">Step-by-step tutorials for modern frontend and full-stack workflows.</p>
      </div>
    </div>

    <div class="space-y-12">
      {shelves.map((shelf) => (
        <RackShelf
          title={`${shelf.publication.data.name} - Featured`}
          items={shelf.items}
          ctaLabel="Latest issue"
          ctaHref={`/issues/${shelf.publication.id}/${shelf.items[0]?.issue.data.issueSlug}`}
        />
      ))}
    </div>
  </div>
</Layout>

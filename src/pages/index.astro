---
import Layout from '../components/layout/Layout.astro';
import IssueCoverCard from '../components/issues/IssueCoverCard.astro';
import { getCollection, getEntry } from 'astro:content';
import { getPostsForIssue } from '../lib/data';
import { coverLinesFromPosts } from '../lib/lineup';

// Get featured publications
const publications = (await getCollection('publications')).filter((p) => p.data.isFeatured);

// Get latest locked issues across all publications (use getCollection directly like issues page)
const allIssues = await getCollection('issues');
const latestIssues = allIssues
  .filter((i) => i.data.status === 'locked')
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
  .slice(0, 8);

const latestItems = await Promise.all(
  latestIssues.map(async (issue) => {
    const publication = await getEntry('publications', issue.data.publicationId);
    const posts = await getPostsForIssue(issue.data.publicationId, issue.data.issueSlug);
    const tilt = (Math.random() - 0.5) * 6;
    return {
      issue,
      publication: publication!,
      coverLines: coverLinesFromPosts(posts as any, 4),
      tilt
    };
  })
);

// Get per-publication shelves
const shelves = await Promise.all(
  publications.map(async (publication) => {
    const pubIssues = allIssues
      .filter((i) => i.data.publicationId === publication.id && i.data.status === 'locked')
      .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
      .slice(0, 4);

    const items = await Promise.all(
      pubIssues.map(async (issue) => {
        const posts = await getPostsForIssue(publication.id, issue.data.issueSlug);
        const tilt = (Math.random() - 0.5) * 5;
        return {
          issue,
          publication,
          coverLines: coverLinesFromPosts(posts as any, 4),
          tilt
        };
      })
    );
    return { publication, items };
  })
);
---

<Layout title="The Rack">
  <div class="rack page-shell">
    <!-- Hero Section -->
    <section class="rack__hero">
      <h1 class="rack__title">Fresh Off The Press</h1>
      <p class="rack__subtitle">Grab a cover, crack it open, start reading</p>
    </section>

    <!-- Latest Issues Shelf -->
    {latestItems.length > 0 && (
      <section class="rack__shelf">
        <h2 class="shelf__label">Latest Issues</h2>
        <div class="shelf__row">
          {latestItems.map((item, idx) => (
            <div class="shelf__item" style={`--tilt: ${item.tilt}deg; --idx: ${idx}`}>
              <IssueCoverCard
                issue={item.issue}
                publication={item.publication}
                coverLines={item.coverLines}
                showStatus
              />
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Quick Actions -->
    <section class="actions-row">
      <a href="/issues" class="btn">Browse All Issues</a>
      <a href="/publications" class="btn btn--secondary">Publications</a>
      <a href="/archive" class="btn btn--secondary">Archive</a>
    </section>

    <!-- Feature Cards -->
    <section class="feature-section">
      <div class="feature-grid">
        <div class="feature-card">
          <div class="feature-card__label">Curated</div>
          <h3 class="feature-card__title">Themed Issues</h3>
          <p class="feature-card__body">Each issue is carefully curated around a theme, with articles that build on each other.</p>
        </div>
        <div class="feature-card">
          <div class="feature-card__label">Practical</div>
          <h3 class="feature-card__title">Real Code</h3>
          <p class="feature-card__body">No fluff. Every tutorial includes working examples you can actually use.</p>
        </div>
        <div class="feature-card">
          <div class="feature-card__label">Fresh</div>
          <h3 class="feature-card__title">Regular Drops</h3>
          <p class="feature-card__body">New issues drop regularly. Subscribe to never miss a release.</p>
        </div>
      </div>
    </section>

    <!-- Per-Publication Shelves -->
    {shelves.filter(s => s.items.length > 0).map((shelf) => (
      <section class="rack__shelf">
        <h2 class="shelf__label">{shelf.publication.data.name}</h2>
        <div class="shelf__row">
          {shelf.items.map((item, idx) => (
            <div class="shelf__item" style={`--tilt: ${item.tilt}deg; --idx: ${idx}`}>
              <IssueCoverCard
                issue={item.issue}
                publication={item.publication}
                coverLines={item.coverLines}
              />
            </div>
          ))}
        </div>
        {shelf.items.length > 0 && (
          <div class="shelf__cta">
            <a href={`/publications/${shelf.publication.id}`} class="btn-link">
              See all from {shelf.publication.data.name}
            </a>
          </div>
        )}
      </section>
    ))}
  </div>
</Layout>

<style>
  .rack {
    padding: 2rem 0 4rem;
  }

  .rack__hero {
    text-align: center;
    padding: 2rem 0 3rem;
  }

  .actions-row {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin: 2rem 0 3rem;
  }

  .feature-section {
    margin: 3rem 0;
  }

  .shelf__cta {
    margin-top: 1rem;
    padding-left: 0.5rem;
  }

  /* Stagger covers for visual interest */
  .shelf__item:nth-child(even) {
    margin-top: 1.5rem;
  }

  .shelf__item:nth-child(3n) {
    margin-top: 0.75rem;
  }
</style>

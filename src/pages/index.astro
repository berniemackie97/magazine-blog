---
import Layout from '../components/Layout.astro';
import PageFrame from '../components/PageFrame.astro';
import RackShelf from '../components/RackShelf.astro';
import { getCollection, getEntry } from 'astro:content';
import { getIssuesForPublication, getPostsForIssue, getLatestIssues } from '../lib/contentSource';
import { coverLinesFromPosts } from '../lib/lineup';

const publications = (await getCollection('publications')).filter((p) => p.data.isFeatured);

const shelves = await Promise.all(
  publications.map(async (publication) => {
    const issues = (await getIssuesForPublication(publication.id))
      .filter((issue: any) => issue.data.status === 'locked')
      .slice(0, 6);
    const items = await Promise.all(
      issues.map(async (issue: any) => {
        const posts = (await getPostsForIssue(publication.id, issue.data.issueSlug)) as any;
        return { issue, publication, coverLines: coverLinesFromPosts(posts as any, 6) };
      })
    );
    return { publication, items };
  })
);

const latestArrivals = await getLatestIssues(6);
const latestShelfItems = await Promise.all(
  latestArrivals.map(async (issue: any) => {
    const publication = await getEntry('publications', issue.data.publicationId);
    const posts = (await getPostsForIssue(issue.data.publicationId, issue.data.issueSlug)) as any;
    return { issue, publication: publication!, coverLines: coverLinesFromPosts(posts as any, 4) };
  })
);
---
<Layout title="Stackbound Press — Rack" heroFrame>
  <div class="space-y-10">
    <div class="newsstand-hero">
      <div class="hero-overlay"></div>
      <div class="hero-grid">
        <div>
          <div class="caps text-xs tracking-[0.2em] text-[var(--accent)]">Newsstand Lobby</div>
          <h1 class="hero-title">Covers first. Then the opener. Then the magazine.</h1>
          <p class="hero-body">Walk the shelves like a bookstore: pick a masthead, grab a fresh issue, flip the opener, dive in.</p>
          <div class="hero-actions">
            <a href="/issues" class="btn-link text-[var(--accent)]">Browse all issues →</a>
            <a href="/archive" class="btn-link text-[var(--accent)]">Archive →</a>
          </div>
        </div>
        <div class="hero-card">
          <div class="caps text-[11px] tracking-[0.2em] text-[var(--accent)]">Stackbound Press</div>
          <div class="mt-2 font-display text-2xl">Two publications, four issues on the rack, more brewing.</div>
          <p class="mt-2 text-sm text-neutral-200">Mastheads, badges, cover lines, rails. Feels like paper, not a feed.</p>
        </div>
      </div>
    </div>
    <div class="space-y-14">
      {shelves.map((shelf) => (
        <RackShelf
          title={`${shelf.publication.data.name} — Featured`}
          items={shelf.items}
          ctaLabel="Pick up latest issue"
          ctaHref={`/issues/${shelf.publication.id}/${shelf.items[0]?.issue.data.issueSlug}`}
        />
      ))}
      <RackShelf title="Latest Arrivals" items={latestShelfItems} ctaLabel="Browse issues" ctaHref="/issues" scrollOnly />
    </div>
  </div>
</Layout>

---
import Layout from '../../components/layout/Layout.astro';
import IssueCoverCard from '../../components/issues/IssueCoverCard.astro';
import { getCollection } from 'astro:content';
import { getPostsForIssue } from '../../lib/data';
import { coverLinesFromPosts } from '../../lib/lineup';

import '../../styles/pages/publications-index.css';

const publications = await getCollection('publications');
const allIssues = await getCollection('issues');

const cards = await Promise.all(
  publications.map(async (publication) => {
    // Get latest locked issue for this publication using raw collection entries
    const pubIssues = allIssues
      .filter((i) => i.data.publicationId === publication.id && i.data.status === 'locked')
      .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

    const issue = pubIssues[0] ?? null;
    const posts = issue ? await getPostsForIssue(publication.id, issue.data.issueSlug) : [];
    return { publication, issue, coverLines: coverLinesFromPosts(posts, 4) };
  })
);
---
<Layout title="Publications - The Rack">
  <div class="page-shell page-content publications-index-page">
    <header class="page-header">
      <h1>Publications</h1>
      <p class="page-header__sub">Different magazines for different vibes</p>
    </header>

    <div class="publications-grid">
      {cards.map((card) => (
        <article class="publication-card" style={`--pub-accent: ${card.publication.data.accent}`}>
          <div class="publication-card__header">
            <h2 class="publication-card__name">{card.publication.data.name}</h2>
            <p class="publication-card__desc">{card.publication.data.description}</p>
            <a href={`/publications/${card.publication.id}`} class="btn">
              View All Issues
            </a>
          </div>
          <div class="publication-card__preview">
            {card.issue ? (
              <IssueCoverCard issue={card.issue} publication={card.publication} coverLines={card.coverLines} />
            ) : (
              <div class="no-issues">
                <p>No published issues yet</p>
              </div>
            )}
          </div>
        </article>
      ))}
    </div>
  </div>
</Layout>

---
import Layout from '../../components/layout/Layout.astro';
import PageFrame from '../../components/layout/PageFrame.astro';
import IssueCoverCard from '../../components/issues/IssueCoverCard.astro';
import { getCollection } from 'astro:content';
import { getLatestLockedIssueForPublication, getPostsForIssue } from '../../lib/data';
import { coverLinesFromPosts } from '../../lib/lineup';

const publications = await getCollection('publications');
const standThemes: Record<string, { backdrop: string; ornament?: string }> = {
  'red-ops': { backdrop: 'linear-gradient(135deg, rgba(255,107,107,0.12), rgba(40,10,16,0.82))' },
  'field-guide': { backdrop: 'linear-gradient(135deg, rgba(58,224,194,0.12), rgba(12,40,40,0.82))' },
};

const cards = await Promise.all(
  publications.map(async (publication) => {
    const issue = await getLatestLockedIssueForPublication(publication.id);
    const posts = issue ? await getPostsForIssue(publication.id, issue.data.issueSlug) : [];
    return { publication, issue, coverLines: coverLinesFromPosts(posts, 4) };
  })
);
---
<Layout title="Publications - Stackbound">
  <PageFrame>
    <div class="mb-6">
      <div class="rack-eyebrow">Stands</div>
      <h1 class="rack-title text-3xl md:text-4xl">Choose a publication.</h1>
      <p class="max-w-2xl text-[var(--muted)]">Each stand keeps its own accent color, typography, and section taxonomy.</p>
    </div>
    <div class="grid gap-6 md:grid-cols-2">
      {cards.map((card) => {
        const theme = standThemes[card.publication.id] ?? { backdrop: 'linear-gradient(135deg, rgba(255,255,255,0.04), rgba(0,0,0,0.4))' };
        return (
          <div class="rack-shell" style={`--accent:${card.publication.data.accent};background:${theme.backdrop};`}>
            <div class="flex items-center justify-between gap-3 mb-3">
              <div>
                <div class="rack-eyebrow">{card.publication.data.name}</div>
                <p class="mt-1 max-w-xl text-sm text-[var(--muted)]">{card.publication.data.description}</p>
              </div>
              <a href={`/publications/${card.publication.id}`} class="btn-link">Enter stand</a>
            </div>
            {card.issue ? (
              <IssueCoverCard issue={card.issue} publication={card.publication} coverLines={card.coverLines} showStatus />
            ) : (
              <div class="feature-card border border-[var(--rule)] bg-[var(--paper-2)]/80 p-4 shadow-paper">
                <div class="font-display text-xl">{card.publication.data.name}</div>
                <p class="text-[var(--muted)]">{card.publication.data.description}</p>
              </div>
            )}
          </div>
        );
      })}
    </div>
  </PageFrame>
</Layout>

---
import Layout from '../../components/Layout.astro';
import PageFrame from '../../components/PageFrame.astro';
import IssueCoverCard from '../../components/IssueCoverCard.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection, getEntry, type CollectionEntry } from 'astro:content';
import { getIssuesForPublication, getPostsByPublication, getPostsForIssue } from '../../lib/data';
import { coverLinesFromPosts } from '../../lib/lineup';

export async function getStaticPaths() {
  const publications = await getCollection('publications');
  return publications.map((publication: CollectionEntry<'publications'>) => ({
    params: { publicationId: publication.id },
  }));
}

const { publicationId } = Astro.params;
const publication = publicationId ? await getEntry('publications', publicationId) : null;
if (!publication) {
  throw new Error('Publication not found');
}

const issues = await getIssuesForPublication(publication.id);
const lockedIssues = issues.filter((i) => i.data.status === 'locked');
const openIssue = issues.find((i) => i.data.status === 'open');
const latestLocked = lockedIssues[0];
const backIssues = lockedIssues.slice(1);

const latestLockedPosts = latestLocked
  ? await getPostsForIssue(publication.id, latestLocked.data.issueSlug)
  : [];
const featuredCoverLines = latestLocked ? coverLinesFromPosts(latestLockedPosts, 5) : [];

const backIssueCards = await Promise.all(
  backIssues.map(async (issue) => {
    const posts = await getPostsForIssue(publication.id, issue.data.issueSlug);
    return { issue, coverLines: coverLinesFromPosts(posts, 4) };
  })
);

const latestArticles = (await getPostsByPublication(publication.id)).slice(0, 4);
---
<Layout title={`${publication.data.name} — Stand`} publication={publication} accent={publication.data.accent}>
  <PageFrame accent={publication.data.accent}>
    <div class="mb-8 flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <div>
        <div class={`caps text-xs tracking-[0.18em] text-[var(--accent)] ${publication.data.displayFont ?? ''}`}>
          {publication.data.name}
        </div>
        <h1 class="font-display text-3xl md:text-4xl">{publication.data.description}</h1>
      </div>
      {openIssue && (
        <a
          href={`/issues/${publication.id}/${openIssue.data.issueSlug}`}
          class="btn-link text-[var(--accent)]"
        >
          Open issue →
        </a>
      )}
    </div>
    {latestLocked && (
      <div class="mb-10">
        <div class="caps mb-2 text-xs tracking-[0.18em] text-[var(--accent)]">Latest locked</div>
        <IssueCoverCard
          issue={latestLocked}
          publication={publication}
          coverLines={featuredCoverLines}
          showStatus
        />
      </div>
    )}
    {openIssue && (
      <div class="mb-10">
        <div class="caps mb-2 text-xs tracking-[0.18em] text-[var(--accent)]">Open Issue</div>
        <IssueCoverCard
          issue={openIssue}
          publication={publication}
          coverLines={coverLinesFromPosts(await getPostsForIssue(publication.id, openIssue.data.issueSlug), 3)}
          showStatus
        />
      </div>
    )}
    {backIssueCards.length > 0 && (
      <div class="mb-10">
        <div class="caps mb-2 text-xs tracking-[0.18em] text-[var(--accent)]">Back issues</div>
        <div class="cover-grid">
          {backIssueCards.map((card) => (
            <IssueCoverCard issue={card.issue} publication={publication} coverLines={card.coverLines} showStatus />
          ))}
        </div>
      </div>
    )}
    {latestArticles.length > 0 && (
      <div>
        <div class="caps mb-2 text-xs tracking-[0.18em] text-[var(--accent)]">Latest articles</div>
        <div class="grid gap-4 md:grid-cols-2">
          {latestArticles.map((post) => (
            <PostCard post={post} publication={publication} />
          ))}
        </div>
      </div>
    )}
  </PageFrame>
</Layout>

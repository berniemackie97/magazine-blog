---
import Layout from '../../components/layout/Layout.astro';
import IssueCoverCard from '../../components/issues/IssueCoverCard.astro';
import PostCard from '../../components/posts/PostCard.astro';
import { getCollection, getEntry, type CollectionEntry } from 'astro:content';
import { getPostsForIssue } from '../../lib/data';
import { coverLinesFromPosts } from '../../lib/lineup';

import '../../styles/pages/publication-detail.css';

export async function getStaticPaths() {
  const publications = await getCollection('publications');
  return publications.map((publication: CollectionEntry<'publications'>) => ({
    params: { publicationId: publication.id },
  }));
}

const { publicationId } = Astro.params;
const publication = publicationId ? await getEntry('publications', publicationId) : null;
if (!publication) {
  throw new Error('Publication not found');
}

// Use raw collection entries to preserve coverSpec inheritance
const allIssues = await getCollection('issues');
const pubIssues = allIssues
  .filter((i) => i.data.publicationId === publication.id)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const lockedIssues = pubIssues.filter((i) => i.data.status === 'locked');
const openIssue = pubIssues.find((i) => i.data.status === 'open') ?? null;
const latestLocked = lockedIssues[0] ?? null;
const backIssues = lockedIssues.slice(1);

const latestLockedPosts = latestLocked ? await getPostsForIssue(publication.id, latestLocked.data.issueSlug) : [];
const featuredCoverLines = latestLocked ? coverLinesFromPosts(latestLockedPosts, 5) : [];

const backIssueCards = await Promise.all(
  backIssues.map(async (issue) => {
    const posts = await getPostsForIssue(publication.id, issue.data.issueSlug);
    const tilt = (Math.random() - 0.5) * 3;
    return { issue, coverLines: coverLinesFromPosts(posts, 4), tilt };
  })
);

// Get latest articles using raw collection
const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const latestArticles = allPosts
  .filter((p) => p.data.publicationId === publication.id)
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 4);
---
<Layout title={`${publication.data.name} - The Rack`} publication={publication} accent={publication.data.accent}>
  <div class="publication-page page-shell page-content">
    <header class="publication-header">
      <span class="publication-label">{publication.data.name}</span>
      <h1 class="publication-title">{publication.data.description}</h1>
      {openIssue && (
        <a href={`/issues/${publication.id}/${openIssue.data.issueSlug}`} class="btn-primary">
          View Open Issue
        </a>
      )}
    </header>

    {latestLocked && (
      <section class="publication-section">
        <h2 class="section-label">Latest Issue</h2>
        <div class="featured-issue">
          <IssueCoverCard issue={latestLocked} publication={publication} coverLines={featuredCoverLines} showStatus />
        </div>
      </section>
    )}

    {openIssue && (
      <section class="publication-section">
        <h2 class="section-label">Open Issue</h2>
        <div class="featured-issue">
          <IssueCoverCard
            issue={openIssue}
            publication={publication}
            coverLines={coverLinesFromPosts(await getPostsForIssue(publication.id, openIssue.data.issueSlug), 3)}
            showStatus
          />
        </div>
      </section>
    )}

    {backIssueCards.length > 0 && (
      <section class="publication-section">
        <h2 class="section-label">Back Issues</h2>
        <div class="back-issues-grid">
          {backIssueCards.map((card) => (
            <div class="back-issue-item" style={`--tilt: ${card.tilt}deg`}>
              <IssueCoverCard issue={card.issue} publication={publication} coverLines={card.coverLines} showStatus />
            </div>
          ))}
        </div>
      </section>
    )}

    {latestArticles.length > 0 && (
      <section class="publication-section">
        <h2 class="section-label">Latest Articles</h2>
        <div class="articles-grid">
          {latestArticles.map((post) => (
            <PostCard post={post} publication={publication} />
          ))}
        </div>
      </section>
    )}
  </div>
</Layout>

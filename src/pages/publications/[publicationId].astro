---
import Layout from '../../components/layout/Layout.astro';
import IssueCoverCard from '../../components/issues/IssueCoverCard.astro';
import PostCard from '../../components/posts/PostCard.astro';
import { getCollection, getEntry, type CollectionEntry } from 'astro:content';
import { getPostsForIssue } from '../../lib/data';
import { coverLinesFromPosts } from '../../lib/lineup';

export async function getStaticPaths() {
  const publications = await getCollection('publications');
  return publications.map((publication: CollectionEntry<'publications'>) => ({
    params: { publicationId: publication.id },
  }));
}

const { publicationId } = Astro.params;
const publication = publicationId ? await getEntry('publications', publicationId) : null;
if (!publication) {
  throw new Error('Publication not found');
}

// Use raw collection entries to preserve coverSpec inheritance
const allIssues = await getCollection('issues');
const pubIssues = allIssues
  .filter((i) => i.data.publicationId === publication.id)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const lockedIssues = pubIssues.filter((i) => i.data.status === 'locked');
const openIssue = pubIssues.find((i) => i.data.status === 'open') ?? null;
const latestLocked = lockedIssues[0] ?? null;
const backIssues = lockedIssues.slice(1);

const latestLockedPosts = latestLocked ? await getPostsForIssue(publication.id, latestLocked.data.issueSlug) : [];
const featuredCoverLines = latestLocked ? coverLinesFromPosts(latestLockedPosts, 5) : [];

const backIssueCards = await Promise.all(
  backIssues.map(async (issue) => {
    const posts = await getPostsForIssue(publication.id, issue.data.issueSlug);
    const tilt = (Math.random() - 0.5) * 3;
    return { issue, coverLines: coverLinesFromPosts(posts, 4), tilt };
  })
);

// Get latest articles using raw collection
const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const latestArticles = allPosts
  .filter((p) => p.data.publicationId === publication.id)
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 4);
---
<Layout title={`${publication.data.name} - The Rack`} publication={publication} accent={publication.data.accent}>
  <div class="publication-page page-shell page-content">
    <header class="publication-header">
      <span class="publication-label">{publication.data.name}</span>
      <h1 class="publication-title">{publication.data.description}</h1>
      {openIssue && (
        <a href={`/issues/${publication.id}/${openIssue.data.issueSlug}`} class="btn-primary">
          View Open Issue
        </a>
      )}
    </header>

    {latestLocked && (
      <section class="publication-section">
        <h2 class="section-label">Latest Issue</h2>
        <div class="featured-issue">
          <IssueCoverCard issue={latestLocked} publication={publication} coverLines={featuredCoverLines} showStatus />
        </div>
      </section>
    )}

    {openIssue && (
      <section class="publication-section">
        <h2 class="section-label">Open Issue</h2>
        <div class="featured-issue">
          <IssueCoverCard
            issue={openIssue}
            publication={publication}
            coverLines={coverLinesFromPosts(await getPostsForIssue(publication.id, openIssue.data.issueSlug), 3)}
            showStatus
          />
        </div>
      </section>
    )}

    {backIssueCards.length > 0 && (
      <section class="publication-section">
        <h2 class="section-label">Back Issues</h2>
        <div class="back-issues-grid">
          {backIssueCards.map((card) => (
            <div class="back-issue-item" style={`--tilt: ${card.tilt}deg`}>
              <IssueCoverCard issue={card.issue} publication={publication} coverLines={card.coverLines} showStatus />
            </div>
          ))}
        </div>
      </section>
    )}

    {latestArticles.length > 0 && (
      <section class="publication-section">
        <h2 class="section-label">Latest Articles</h2>
        <div class="articles-grid">
          {latestArticles.map((post) => (
            <PostCard post={post} publication={publication} />
          ))}
        </div>
      </section>
    )}
  </div>
</Layout>

<style>
  .publication-page {
    padding: 2rem 0;
  }

  .publication-header {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 3px solid var(--ink-rich);
  }

  .publication-label {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: 0.5rem;
  }

  .publication-title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    line-height: 1.2;
    margin-bottom: 1.5rem;
  }

  .btn-primary {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    background: var(--ink-rich);
    color: var(--surface-base);
    border: 2px solid var(--ink-rich);
    border-radius: 6px;
    box-shadow: 4px 4px 0 var(--ink-faint);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .btn-primary:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--ink-faint);
  }

  .publication-section {
    margin-bottom: 3rem;
  }

  .section-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px dashed var(--ink-faint);
  }

  .featured-issue {
    max-width: 400px;
  }

  .back-issues-grid {
    display: grid;
    gap: 2rem;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }

  .back-issue-item {
    transform: rotate(var(--tilt, 0deg));
    transition: transform 0.2s ease;
  }

  .back-issue-item:hover {
    transform: rotate(0deg) scale(1.02);
  }

  .articles-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }

  @media (min-width: 768px) {
    .articles-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

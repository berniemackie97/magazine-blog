---
import Layout from '../../components/Layout.astro';
import PageFrame from '../../components/PageFrame.astro';
import SectionTag from '../../components/SectionTag.astro';
import BylineBlock from '../../components/BylineBlock.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection, getEntry } from 'astro:content';
import {
  getIssue,
  getPostsByPublication,
  getPostsForIssue,
  getPostBySlug,
  getLatestPosts,
  useCms,
  getPublication as getPublicationCs,
} from '../../lib/contentSource';
import readingTime from 'reading-time';
import PortableTextRenderer from '../../components/PortableTextRenderer';

export async function getStaticPaths() {
  if (useCms) {
    const posts = await getLatestPosts(200);
    return posts.map((post: any) => ({ params: { slug: post.data.slug } }));
  }
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = useCms
  ? await getPostBySlug(slug!)
  : (await getCollection('posts', ({ data }) => !data.draft)).find((p) => p.slug === slug);
if (!post) {
  throw new Error('Post not found');
}

const publicationId = (post as any).data.publicationId ?? (post as any).data.publication?.id;
const postSlug = (post as any).slug ?? (post as any).data.slug;
const publication = useCms ? await getPublicationCs(publicationId) : await getEntry('publications', publicationId);
if (!publication) {
  throw new Error('Publication missing');
}

const cmsBody = useCms ? (post as any).data.body ?? [] : null;
const { Content } = useCms ? { Content: null } : await post.render();
const bodyText = useCms
  ? (cmsBody ?? [])
      .map((block: any) => {
        if (block._type === 'block' && block.children) {
          return block.children.map((c: any) => c.text).join(' ');
        }
        return '';
      })
      .join(' ')
  : (post as any).body ?? '';
const readingTimeMinutes = Math.max(1, Math.round(readingTime(bodyText).minutes));
const issue = (post as any).data.issueSlug ? await getIssue(publicationId, (post as any).data.issueSlug) : null;
const issuePosts = issue ? await getPostsForIssue(publicationId, issue.data.issueSlug) : [];
const index = issuePosts.findIndex((p: any) => (p.slug ?? p.data.slug) === postSlug);
const prevInIssue = index > 0 ? issuePosts[index - 1] : null;
const nextInIssue = index >= 0 && index + 1 < issuePosts.length ? issuePosts[index + 1] : null;

const moreFromPub = ((await getPostsByPublication(publicationId)) as any)
  .filter((p: any) => (p.slug ?? p.data.slug) !== postSlug)
  .slice(0, 3);
---
<Layout title={`${post.data.headline} - ${publication.data.name}`} publication={publication} accent={publication.data.accent}>
  <PageFrame accent={publication.data.accent}>
    <article class="article">
      <SectionTag label={post.data.sectionId} />
      <h1 class={`mt-3 rack-title text-4xl leading-tight md:text-5xl ${publication.data.displayFont ?? ''}`}>
        {post.data.headline}
      </h1>
      <p class="mt-3 max-w-3xl text-lg text-[var(--muted)]">{post.data.dek}</p>
      <BylineBlock post={{ ...post, readingTimeMinutes }} publication={publication} />
      <div class="article-body mt-6">
        {useCms ? <PortableTextRenderer value={cmsBody} /> : <Content />}
      </div>
    </article>
    {issue && (
      <div class="mt-10 feature-card border border-[var(--rule)] bg-[var(--paper-2)]/85 p-4 shadow-paper">
        <div class="flex items-center justify-between">
          <div>
            <div class="rack-eyebrow mb-1">In this issue</div>
            <div class="font-display text-xl text-[var(--ink)]">{issue.data.displayTitle}</div>
          </div>
          <a href={`/issues/${issue.data.publicationId}/${issue.data.issueSlug}`} class="btn-link">Issue opener</a>
        </div>
        <div class="mt-3 flex flex-wrap gap-4 text-sm uppercase tracking-[0.14em]">
          {prevInIssue && (
            <a href={`/posts/${prevInIssue.slug}`} class="rounded-sm border border-[var(--rule)] bg-[var(--paper-3)]/70 px-3 py-2">
              Prev: {prevInIssue.data.headline}
            </a>
          )}
          {nextInIssue && (
            <a href={`/posts/${nextInIssue.slug}`} class="rounded-sm border border-[var(--rule)] bg-[var(--paper-3)]/70 px-3 py-2">
              Next: {nextInIssue.data.headline}
            </a>
          )}
        </div>
      </div>
    )}
    {moreFromPub.length > 0 && (
      <div class="mt-10">
        <div class="rack-eyebrow mb-2">More from {publication.data.name}</div>
        <div class="grid gap-4 md:grid-cols-3">
          {moreFromPub.map((p: any) => (
            <PostCard post={p} publication={publication} showSummary />
          ))}
        </div>
      </div>
    )}
  </PageFrame>
</Layout>

---
import Layout from '../../components/layout/Layout.astro';
import Sidebar from '../../components/layout/Sidebar.astro';
import PostCard from '../../components/posts/PostCard.astro';
import { getCollection, getEntry } from 'astro:content';
import {
  getIssue,
  getPostsByPublication,
  getPostsForIssue,
} from '../../lib/data';
import readingTime from 'reading-time';

import '../../styles/pages/post-detail.css';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = (await getCollection('posts', ({ data }) => !data.draft)).find((p) => p.slug === slug);
if (!post) {
  throw new Error('Post not found');
}

const publicationId = post.data.publicationId;
const postSlug = post.slug;
const publication = await getEntry('publications', publicationId);
if (!publication) {
  throw new Error('Publication missing');
}

const { Content } = await post.render();
const bodyText = post.body ?? '';
const readingTimeMinutes = Math.max(1, Math.round(readingTime(bodyText).minutes));
const issue = post.data.issueSlug ? await getIssue(publicationId, post.data.issueSlug) : null;
const issuePosts = issue ? await getPostsForIssue(publicationId, issue.data.issueSlug) : [];
const index = issuePosts.findIndex((p) => p.slug === postSlug);
const prevInIssue = index > 0 ? issuePosts[index - 1] : null;
const nextInIssue = index >= 0 && index + 1 < issuePosts.length ? issuePosts[index + 1] : null;

const moreFromPub = (await getPostsByPublication(publicationId))
  .filter((p) => p.slug !== postSlug)
  .slice(0, 3);

const formattedDate = new Date(post.data.publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---
<Layout title={`${post.data.headline} - ${publication.data.name}`} publication={publication} accent={publication.data.accent}>
  <article class="article-page">
    <header class="article-header page-shell">
      <div class="article-meta">
        <span class="badge badge--accented" style={`--badge-accent: ${publication.data.accent}`}>
          {publication.data.name}
        </span>
        <span class="article-meta__date">{formattedDate}</span>
        <span class="article-meta__time">{readingTimeMinutes} min read</span>
      </div>
      <h1 class="article-title">{post.data.headline}</h1>
      <p class="article-dek">{post.data.dek}</p>
    </header>

    <div class="article-layout page-shell">
      <div class="article-main">
        <div class="article-content">
          <div class="article-body">
            <Content />
          </div>
        </div>

        {issue && (
          <aside class="issue-nav">
            <div class="issue-nav__header">
              <span class="issue-nav__label">From this issue</span>
              <a href={`/issues/${issue.data.publicationId}/${issue.data.issueSlug}`} class="btn-link">
                {issue.data.displayTitle}
              </a>
            </div>
            <div class="issue-nav__links">
              {prevInIssue && (
                <a href={`/posts/${prevInIssue.slug}`} class="issue-nav__link">
                  <span class="issue-nav__dir">Previous</span>
                  <span class="issue-nav__text">{prevInIssue.data.headline}</span>
                </a>
              )}
              {nextInIssue && (
                <a href={`/posts/${nextInIssue.slug}`} class="issue-nav__link">
                  <span class="issue-nav__dir">Next</span>
                  <span class="issue-nav__text">{nextInIssue.data.headline}</span>
                </a>
              )}
            </div>
          </aside>
        )}
      </div>

      <div class="article-sidebar">
        <Sidebar
          publication={publication}
          issue={issue}
          recentPosts={moreFromPub}
        />
      </div>
    </div>

    {moreFromPub.length > 0 && (
      <section class="more-posts page-shell">
        <h2 class="more-posts__title">More from {publication.data.name}</h2>
        <div class="more-posts__grid">
          {moreFromPub.map((p) => (
            <PostCard post={p} publication={publication} />
          ))}
        </div>
      </section>
    )}
  </article>
</Layout>

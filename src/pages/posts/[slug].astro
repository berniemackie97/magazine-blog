---
import Layout from '../../components/layout/Layout.astro';
import PostCard from '../../components/posts/PostCard.astro';
import { getCollection, getEntry } from 'astro:content';
import {
  getIssue,
  getPostsByPublication,
  getPostsForIssue,
  getPostBySlug,
  getLatestPosts,
  useCms,
  getPublication as getPublicationCs,
} from '../../lib/contentSource';
import readingTime from 'reading-time';
import PortableTextRenderer from '../../components/cms/PortableTextRenderer';

export async function getStaticPaths() {
  if (useCms) {
    const posts = await getLatestPosts(200);
    return posts.map((post: any) => ({ params: { slug: post.data.slug } }));
  }
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;
const post = useCms
  ? await getPostBySlug(slug!)
  : (await getCollection('posts', ({ data }) => !data.draft)).find((p) => p.slug === slug);
if (!post) {
  throw new Error('Post not found');
}

const publicationId = (post as any).data.publicationId ?? (post as any).data.publication?.id;
const postSlug = (post as any).slug ?? (post as any).data.slug;
const publication = useCms ? await getPublicationCs(publicationId) : await getEntry('publications', publicationId);
if (!publication) {
  throw new Error('Publication missing');
}

const cmsBody = useCms ? (post as any).data.body ?? [] : null;
const { Content } = useCms ? { Content: null } : await post.render();
const bodyText = useCms
  ? (cmsBody ?? [])
      .map((block: any) => {
        if (block._type === 'block' && block.children) {
          return block.children.map((c: any) => c.text).join(' ');
        }
        return '';
      })
      .join(' ')
  : (post as any).body ?? '';
const readingTimeMinutes = Math.max(1, Math.round(readingTime(bodyText).minutes));
const issue = (post as any).data.issueSlug ? await getIssue(publicationId, (post as any).data.issueSlug) : null;
const issuePosts = issue ? await getPostsForIssue(publicationId, issue.data.issueSlug) : [];
const index = issuePosts.findIndex((p: any) => (p.slug ?? p.data.slug) === postSlug);
const prevInIssue = index > 0 ? issuePosts[index - 1] : null;
const nextInIssue = index >= 0 && index + 1 < issuePosts.length ? issuePosts[index + 1] : null;

const moreFromPub = ((await getPostsByPublication(publicationId)) as any)
  .filter((p: any) => (p.slug ?? p.data.slug) !== postSlug)
  .slice(0, 3);

const formattedDate = new Date(post.data.publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---
<Layout title={`${post.data.headline} - ${publication.data.name}`} publication={publication} accent={publication.data.accent}>
  <article class="article-page">
    <header class="article-header page-shell">
      <div class="article-meta">
        <span class="badge" style={`background: ${publication.data.accent}; color: white; border-color: ${publication.data.accent}`}>
          {publication.data.name}
        </span>
        <span class="article-meta__date">{formattedDate}</span>
        <span class="article-meta__time">{readingTimeMinutes} min read</span>
      </div>
      <h1 class="article-title">{post.data.headline}</h1>
      <p class="article-dek">{post.data.dek}</p>
    </header>

    <div class="article-content page-shell">
      <div class="article-body">
        {useCms ? <PortableTextRenderer value={cmsBody} /> : <Content />}
      </div>
    </div>

    {issue && (
      <aside class="issue-nav page-shell">
        <div class="issue-nav__header">
          <span class="issue-nav__label">From this issue</span>
          <a href={`/issues/${issue.data.publicationId}/${issue.data.issueSlug}`} class="btn-link">
            {issue.data.displayTitle}
          </a>
        </div>
        <div class="issue-nav__links">
          {prevInIssue && (
            <a href={`/posts/${prevInIssue.slug ?? prevInIssue.data.slug}`} class="issue-nav__link">
              <span class="issue-nav__dir">Previous</span>
              <span class="issue-nav__text">{prevInIssue.data.headline}</span>
            </a>
          )}
          {nextInIssue && (
            <a href={`/posts/${nextInIssue.slug ?? nextInIssue.data.slug}`} class="issue-nav__link">
              <span class="issue-nav__dir">Next</span>
              <span class="issue-nav__text">{nextInIssue.data.headline}</span>
            </a>
          )}
        </div>
      </aside>
    )}

    {moreFromPub.length > 0 && (
      <section class="more-posts page-shell">
        <h2 class="more-posts__title">More from {publication.data.name}</h2>
        <div class="more-posts__grid">
          {moreFromPub.map((p: any) => (
            <PostCard post={p} publication={publication} />
          ))}
        </div>
      </section>
    )}
  </article>
</Layout>

<style>
  .article-page {
    padding: 2rem 0;
  }

  .article-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .article-meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--ink-muted);
  }

  .article-title {
    font-size: clamp(2rem, 5vw, 3rem);
    max-width: 800px;
    margin: 0 auto 1rem;
  }

  .article-dek {
    font-size: 1.25rem;
    color: var(--ink-muted);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .article-content {
    margin-bottom: 3rem;
  }

  .issue-nav {
    background: var(--surface-raised);
    border: 2px solid var(--ink-rich);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 3rem;
    box-shadow: 4px 4px 0 var(--ink-rich);
  }

  .issue-nav__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px dashed var(--ink-faint);
  }

  .issue-nav__label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-muted);
  }

  .issue-nav__links {
    display: grid;
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .issue-nav__links {
      grid-template-columns: 1fr 1fr;
    }
  }

  .issue-nav__link {
    display: block;
    padding: 1rem;
    background: var(--surface-sunken);
    border: 2px solid var(--ink-faint);
    border-radius: 8px;
    transition: border-color 0.15s ease;
  }

  .issue-nav__link:hover {
    border-color: var(--ink-rich);
  }

  .issue-nav__dir {
    display: block;
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-muted);
    margin-bottom: 0.25rem;
  }

  .issue-nav__text {
    font-family: var(--font-display);
    font-size: 0.95rem;
    color: var(--ink-rich);
  }

  .more-posts {
    margin-top: 3rem;
  }

  .more-posts__title {
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .more-posts__grid {
    display: grid;
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .more-posts__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

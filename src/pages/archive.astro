---
import Layout from '../components/layout/Layout.astro';
import PostCard from '../components/posts/PostCard.astro';
import { getCollection } from 'astro:content';
import readingTime from 'reading-time';
import { useCms, getLatestPosts } from '../lib/contentSource';

const publications = await getCollection('publications');
const publicationMap = Object.fromEntries(publications.map((p) => [p.id, p]));
const posts = useCms
  ? await getLatestPosts(200)
  : (await getCollection('posts', ({ data }) => !data.draft)).map((post) => ({
      ...post,
      readingTimeMinutes: Math.max(1, Math.round(readingTime(post.body).minutes)),
    }));
const normalizedPosts = posts.map((post: any) => ({
  ...post,
  data: {
    ...post.data,
    publicationId: post.data.publicationId ?? post.data.publication?.id ?? '',
    tags: post.data.tags ?? [],
  },
}));

const sortedPosts = normalizedPosts.sort(
  (a: any, b: any) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);
---
<Layout title="Archive - The Rack">
  <div class="page-shell page-content">
    <header class="page-header">
      <h1>Archive</h1>
      <p class="page-header__sub">Every article we've ever published</p>
    </header>

    <div class="filter-bar">
      <select id="pub-filter" class="filter-select">
        <option value="">All Publications</option>
        {publications.map((p) => (
          <option value={p.id}>{p.data.name}</option>
        ))}
      </select>
    </div>

    <div class="posts-grid">
      {sortedPosts.map((post: any) => (
        <div
          data-filter-item
          data-publication={post.data.publicationId}
        >
          <PostCard post={post} publication={publicationMap[post.data.publicationId]} />
        </div>
      ))}
    </div>
  </div>

  <script is:inline>
    const select = document.getElementById('pub-filter');
    const items = document.querySelectorAll('[data-filter-item]');

    if (select) {
      select.addEventListener('change', (e) => {
        const value = e.target.value;
        items.forEach((item) => {
          if (!value || item.dataset.publication === value) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }
  </script>
</Layout>

<style>
  .page-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .page-header__sub {
    font-family: var(--font-hand);
    font-size: 1.25rem;
    color: var(--ink-muted);
  }

  .filter-bar {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .filter-select {
    padding: 0.5rem 1rem;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    background: var(--surface-raised);
    border: 2px solid var(--ink-rich);
    border-radius: 6px;
    cursor: pointer;
  }

  .filter-select:focus {
    outline: 3px solid var(--pop-coral);
    outline-offset: 2px;
  }

  .posts-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
</style>

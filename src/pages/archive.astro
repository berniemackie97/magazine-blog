---
import Layout from '../components/Layout.astro';
import PageFrame from '../components/PageFrame.astro';
import Filters from '../components/Filters.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';
import readingTime from 'reading-time';
import { useCms, getLatestPosts } from '../lib/contentSource';

const publications = await getCollection('publications');
const publicationMap = Object.fromEntries(publications.map((p) => [p.id, p]));
const posts = useCms
  ? await getLatestPosts(200)
  : (await getCollection('posts', ({ data }) => !data.draft)).map((post) => ({
      ...post,
      readingTimeMinutes: Math.max(1, Math.round(readingTime(post.body).minutes)),
    }));
const normalizedPosts = posts.map((post: any) => ({
  ...post,
  data: {
    ...post.data,
    publicationId: post.data.publicationId ?? post.data.publication?.id ?? '',
    tags: post.data.tags ?? [],
  },
}));

const filters = {
  publications: publications.map((p) => ({ label: p.data.name, value: p.id })),
  sections: Array.from(
    new Map(
      normalizedPosts.map((p: any) => {
        const section = publicationMap[p.data.publicationId]?.data.sections.find((s: any) => s.id === p.data.sectionId);
        return [p.data.sectionId, section?.label ?? p.data.sectionId];
      })
    ).entries()
  ).map(([value, label]) => ({ value: value as string, label: label as string })),
  formats: Array.from(new Set(normalizedPosts.map((p: any) => p.data.format))).map((v) => ({ value: v as string, label: v as string })),
  difficulties: Array.from(new Set(normalizedPosts.map((p: any) => p.data.difficulty))).map((v) => ({ value: v as string, label: v as string })),
  tags: Array.from(new Set(normalizedPosts.flatMap((p: any) => p.data.tags ?? []).filter(Boolean))).map((v) => ({ value: v as string, label: v as string })),
};

const sortedPosts = normalizedPosts.sort(
  (a: any, b: any) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);
---
<Layout title="Archive â€” Stackbound">
  <PageFrame>
    <div class="mb-6">
      <div class="caps text-xs tracking-[0.18em] text-[var(--accent)]">Archive</div>
      <h1 class="font-display text-3xl md:text-4xl">Every article, filtered without reload.</h1>
    </div>
    <Filters {...filters} />
    <div class="grid gap-4 md:grid-cols-3">
      {sortedPosts.map((post: any) => (
        <div
          data-filter-item
          data-publication={post.data.publicationId}
          data-section={post.data.sectionId}
          data-format={post.data.format}
          data-difficulty={post.data.difficulty}
          data-tags={post.data.tags.join(',')}
        >
          <PostCard post={post} publication={publicationMap[post.data.publicationId]} />
        </div>
      ))}
    </div>
  </PageFrame>
</Layout>

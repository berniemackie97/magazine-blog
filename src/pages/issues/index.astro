---
import Layout from '../../components/layout/Layout.astro';
import IssueCoverCard from '../../components/issues/IssueCoverCard.astro';
import { getCollection, getEntry } from 'astro:content';
import { getPostsForIssue } from '../../lib/data';
import { coverLinesFromPosts } from '../../lib/lineup';

import '../../styles/pages/issues-index.css';

const issues = (await getCollection('issues'))
  .filter((issue) => issue.data.status === 'locked')
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const issueCards = await Promise.all(
  issues.map(async (issue) => {
    const publication = await getEntry('publications', issue.data.publicationId);
    const posts = await getPostsForIssue(issue.data.publicationId, issue.data.issueSlug);
    const tilt = (Math.random() - 0.5) * 3;
    return { issue, publication: publication!, coverLines: coverLinesFromPosts(posts, 5), tilt };
  })
);

const publications = await getCollection('publications');
---
<Layout title="All Issues - The Rack">
  <div class="page-shell page-content issues-index-page">
    <header class="page-header">
      <h1>Browse All Issues</h1>
      <p class="page-header__sub">Every issue we've published, ready to read.</p>
    </header>

    <div class="filter-bar">
      <select id="pub-filter" class="filter-select">
        <option value="">All Publications</option>
        {publications.map((p) => (
          <option value={p.id}>{p.data.name}</option>
        ))}
      </select>
    </div>

    <div class="shelf-grid" id="issue-grid">
      {issueCards.map((card) => (
        <div
          data-filter-item
          data-publication={card.publication.id}
          style={`--tilt: ${card.tilt}deg`}
        >
          <IssueCoverCard issue={card.issue} publication={card.publication} coverLines={card.coverLines} showStatus />
        </div>
      ))}
    </div>
  </div>

  <script is:inline>
    const select = document.getElementById('pub-filter');
    const items = document.querySelectorAll('[data-filter-item]');

    if (select) {
      select.addEventListener('change', (e) => {
        const value = e.target.value;
        items.forEach((item) => {
          if (!value || item.dataset.publication === value) {
            item.style.display = '';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }
  </script>
</Layout>

---
import Layout from '../../components/Layout.astro';
import PageFrame from '../../components/PageFrame.astro';
import SectionTag from '../../components/SectionTag.astro';
import BylineBlock from '../../components/BylineBlock.astro';
import PostCard from '../../components/PostCard.astro';
import PortableTextRenderer from '../../components/PortableTextRenderer';
import { getIssue, getPostsByPublication, getPostsForIssue, getPublication as getPub } from '../../lib/contentSource';
import { getPostBySlug } from '../../lib/cmsData';

export const prerender = false;

const { slug } = Astro.params;

const post = await getPostBySlug(slug!, { includeDraft: true });
if (!post) {
  throw new Error('Post not found in preview');
}

const publication = await getPub(post.data.publicationId);
if (!publication) {
  throw new Error('Publication missing');
}

const cmsBody = post.data.body ?? [];
const issue = post.data.issueSlug ? await getIssue(post.data.publicationId, post.data.issueSlug) : null;
const issuePosts = issue ? await getPostsForIssue(post.data.publicationId, issue.data.issueSlug) : [];
const idx = issuePosts.findIndex((p: any) => (p.slug ?? p.data.slug) === slug);
const prevInIssue = idx > 0 ? issuePosts[idx - 1] : null;
const nextInIssue = idx >= 0 && idx + 1 < issuePosts.length ? issuePosts[idx + 1] : null;
const moreFromPub = ((await getPostsByPublication(post.data.publicationId)) as any)
  .filter((p: any) => (p.slug ?? p.data.slug) !== slug)
  .slice(0, 3);
---
<Layout title={`Preview: ${post.data.headline} - ${publication.data.name}`} publication={publication} accent={publication.data.accent}>
  <PageFrame accent={publication.data.accent}>
    <div class="rounded-sm bg-amber-500/10 px-3 py-2 text-sm text-amber-200">
      Preview mode: drafts and unpublished changes are visible here.
    </div>
    <article class="article mt-4">
      <SectionTag label={`${post.data.sectionId} — preview`} />
      <h1 class={`mt-3 font-display text-4xl leading-tight md:text-5xl ${publication.data.displayFont ?? ''}`}>
        {post.data.headline}
      </h1>
      <p class="mt-3 max-w-3xl text-lg text-neutral-200">{post.data.dek}</p>
      <BylineBlock post={post} publication={publication} />
      <div class="article-body mt-6">
        <PortableTextRenderer value={cmsBody} />
      </div>
    </article>
    {issue && (
      <div class="mt-10 rounded-lg border border-[var(--rule)] bg-[var(--paper)] p-4 shadow-paper">
        <div class="flex items-center justify-between">
          <div>
            <div class="caps text-xs font-semibold tracking-[0.18em] text-[var(--accent)]">In this issue</div>
            <div class="font-display text-xl">{issue.data.displayTitle}</div>
          </div>
          <a href={`/issues/${issue.data.publicationId}/${issue.data.issueSlug}`} class="btn-link text-[var(--accent)]">Issue opener -></a>
        </div>
        <div class="mt-3 flex flex-wrap gap-4 text-sm uppercase tracking-[0.14em]">
          {prevInIssue && (
            <a href={`/posts/${prevInIssue.slug}`} class="rounded-sm border border-[var(--rule)] px-3 py-2">
              {'←'} {prevInIssue.data.headline}
            </a>
          )}
          {nextInIssue && (
            <a href={`/posts/${nextInIssue.slug}`} class="rounded-sm border border-[var(--rule)] px-3 py-2">
              {nextInIssue.data.headline} {'→'}
            </a>
          )}
        </div>
      </div>
    )}
    {moreFromPub.length > 0 && (
      <div class="mt-10">
        <div class="caps mb-2 text-xs font-semibold tracking-[0.18em] text-[var(--accent)]">More from {publication.data.name}</div>
        <div class="grid gap-4 md:grid-cols-3">
          {moreFromPub.map((p: any) => (
            <PostCard post={p} publication={publication} showSummary />
          ))}
        </div>
      </div>
    )}
  </PageFrame>
</Layout>

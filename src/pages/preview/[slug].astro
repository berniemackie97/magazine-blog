---
import type { CollectionEntry } from "astro:content";

import Layout from "../../components/layout/Layout.astro";
import PageFrame from "../../components/layout/PageFrame.astro";
import SectionTag from "../../components/ui/SectionTag.astro";
import BylineBlock from "../../components/posts/BylineBlock.astro";
import PostCard from "../../components/posts/PostCard.astro";
import PortableTextRenderer from "../../components/cms/PortableTextRenderer";

import {
  getIssue,
  getPostsByPublication,
  getPostsForIssue,
  getPublication as getPub,
} from "../../lib/contentSource";

import { getPostBySlug } from "../../lib/cmsData";
import type { PostRecord, PublicationRecord } from "../../lib/contentTypes";

export const prerender = false;

type PublicationEntry = CollectionEntry<"publications">;
type PostEntry = CollectionEntry<"posts">;

function asPublicationEntry(pub: PublicationRecord): PublicationEntry {
  // Bridge adapter: Layout/Byline/PostCard currently type against CollectionEntry.
  return {
    id: pub.id,
    collection: "publications",
    data: pub.data as any,
    body: "",
  } as unknown as PublicationEntry;
}

function asPostEntry(post: PostRecord, bodyText = ""): PostEntry {
  // Bridge adapter: content collection entries have render/body/collection.
  // We provide minimal fields for components that only read .data/.slug.
  return {
    id: post.id,
    slug: post.slug,
    collection: "posts",
    data: post.data as any,
    body: bodyText,
    render: async () => {
      throw new Error("render() is not available for CMS-backed preview posts.");
    },
  } as unknown as PostEntry;
}

const { slug } = Astro.params;
if (!slug) throw new Error("Missing slug");

const basePost = await getPostBySlug(slug, { includeDraft: true });
if (!basePost) {
  throw new Error("Post not found in preview");
}

// Preview may have portable text living on the record or (in some setups) inside data.
// We support both without mutating the canonical PostRecord type.
const bodyCandidate =
  (basePost as any).body ?? (basePost as any).data?.body ?? [];
const cmsBody: unknown[] = Array.isArray(bodyCandidate) ? bodyCandidate : [];

const publication = await getPub(basePost.data.publicationId);
if (!publication) {
  throw new Error("Publication missing");
}

const publicationEntry = asPublicationEntry(publication);
const postEntry = asPostEntry(basePost);

const issue = basePost.data.issueSlug
  ? await getIssue(basePost.data.publicationId, basePost.data.issueSlug)
  : null;

const issuePosts = issue
  ? await getPostsForIssue(basePost.data.publicationId, issue.data.issueSlug)
  : [];

const idx = issuePosts.findIndex((p) => p.slug === slug);
const prevInIssue = idx > 0 ? issuePosts[idx - 1] : null;
const nextInIssue =
  idx >= 0 && idx + 1 < issuePosts.length ? issuePosts[idx + 1] : null;

const moreFromPub = (await getPostsByPublication(basePost.data.publicationId))
  .filter((p) => p.slug !== slug)
  .slice(0, 3);

const moreFromPubEntries = moreFromPub.map((p) => asPostEntry(p));
---

<Layout
  title={`Preview: ${basePost.data.headline} - ${publication.data.name}`}
  publication={publicationEntry}
  accent={publication.data.accent}
>
  <PageFrame accent={publication.data.accent}>
    <div class="rounded-sm bg-amber-500/10 px-3 py-2 text-sm text-amber-200">
      Preview mode: drafts and unpublished changes are visible here.
    </div>

    <article class="article mt-4">
      <SectionTag label={`${basePost.data.sectionId} - preview`} />

      <h1 class={`mt-3 font-display text-4xl leading-tight md:text-5xl ${publication.data.displayFont ?? ""}`}>
        {basePost.data.headline}
      </h1>

      <p class="mt-3 max-w-3xl text-lg text-neutral-200">{basePost.data.dek}</p>

      <BylineBlock post={postEntry} publication={publicationEntry} />

      <div class="article-body mt-6">
        <PortableTextRenderer value={cmsBody as any} />
      </div>
    </article>

    {issue && (
      <div class="mt-10 rounded-lg border border-[var(--rule)] bg-[var(--paper)] p-4 shadow-paper">
        <div class="flex items-center justify-between">
          <div>
            <div class="caps text-xs font-semibold tracking-[0.18em] text-[var(--accent)]">In this issue</div>
            <div class="font-display text-xl">{issue.data.displayTitle}</div>
          </div>

          <a
            href={`/issues/${issue.data.publicationId}/${issue.data.issueSlug}`}
            class="btn-link text-[var(--accent)]"
          >
            Issue opener &gt;
          </a>
        </div>

        <div class="mt-3 flex flex-wrap gap-4 text-sm uppercase tracking-[0.14em]">
          {prevInIssue && (
            <a href={`/posts/${prevInIssue.slug}`} class="rounded-sm border border-[var(--rule)] px-3 py-2">
              {"<"} {prevInIssue.data.headline}
            </a>
          )}

          {nextInIssue && (
            <a href={`/posts/${nextInIssue.slug}`} class="rounded-sm border border-[var(--rule)] px-3 py-2">
              {nextInIssue.data.headline} {">"}
            </a>
          )}
        </div>
      </div>
    )}

    {moreFromPubEntries.length > 0 && (
      <div class="mt-10">
        <div class="caps mb-2 text-xs font-semibold tracking-[0.18em] text-[var(--accent)]">
          More from {publication.data.name}
        </div>
        <div class="grid gap-4 md:grid-cols-3">
          {moreFromPubEntries.map((p) => (
            <PostCard post={p} publication={publicationEntry} showSummary />
          ))}
        </div>
      </div>
    )}
  </PageFrame>
</Layout>

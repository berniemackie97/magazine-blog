---
import type { CoverSpec, CoverTheme, CoverBlock, CoverBlockTitle, CoverFeatureItem } from "../../lib/contentTypes";

interface Props {
  spec: CoverSpec;
  href?: string;
  interactive?: boolean;
  ariaLabel?: string;
}

const { spec, href, interactive = true, ariaLabel } = Astro.props;

// Extract blocks by type for easier templating
const masthead = spec.blocks.find((b) => b.type === "masthead");
const meta = spec.blocks.find((b) => b.type === "meta");
const art = spec.blocks.find((b) => b.type === "art");
const title = spec.blocks.find((b) => b.type === "title") as CoverBlockTitle | undefined;
const featureList = spec.blocks.find((b) => b.type === "featureList");
const sticker = spec.blocks.find((b) => b.type === "sticker");
const barcode = spec.blocks.find((b) => b.type === "barcode");
const cta = spec.blocks.find((b) => b.type === "cta");
const spine = spec.blocks.find((b) => b.type === "spine");

const computedAriaLabel = ariaLabel ?? (title ? `Open issue: ${title.title}` : "Open issue");

function themeToVars(theme?: CoverTheme): string | undefined {
  if (!theme) return undefined;
  const parts: string[] = [];
  if (theme.paper) parts.push(`--cover-paper: ${theme.paper};`);
  if (theme.ink) parts.push(`--cover-ink: ${theme.ink};`);
  if (theme.accent) parts.push(`--cover-accent: ${theme.accent};`);
  if (theme.alt) parts.push(`--cover-alt: ${theme.alt};`);
  if (theme.photo) parts.push(`--cover-photo: ${theme.photo};`);
  return parts.length ? parts.join(" ") : undefined;
}

const coverStyle = themeToVars(spec.theme);
const templateClass = spec.template ? `cover--${spec.template}` : "cover--bold-pop";
const coverClass = `cover ${templateClass}`;

const WrapperTag = href ? "a" : "div";
const wrapperProps = href
  ? { href, class: coverClass, style: coverStyle, "aria-label": computedAriaLabel }
  : { class: coverClass, style: coverStyle };
---

<WrapperTag {...wrapperProps}>
  <!-- Spine -->
  {spine && (
    <div class="cover__spine">
      <span class="cover__spine-text">{spine.text}</span>
    </div>
  )}

  <!-- Main cover content -->
  <div class="cover__face">
    <!-- Header: Masthead + Status -->
    {masthead && (
      <header class="cover__header">
        <div class="cover__pub-name">{masthead.publicationName}</div>
        {masthead.statusText && (
          <span class="cover__status">{masthead.statusText}</span>
        )}
      </header>
    )}

    <!-- Meta line: Vol/No/Date/Price -->
    {meta && (
      <div class="cover__meta">
        <span>{meta.left}</span>
        {meta.price && <span class="cover__price">{meta.price}</span>}
        <span>{meta.right}</span>
      </div>
    )}

    <!-- Feature image / art area -->
    {art && (
      <div
        class="cover__art"
        style={art.background ? `background-image: url(${art.background});` : undefined}
      />
    )}

    <!-- Main title block -->
    {title && (
      <div class="cover__title-block">
        <h3 class="cover__title">{title.title}</h3>
        {title.dek && <p class="cover__dek">{title.dek}</p>}
      </div>
    )}

    <!-- Feature list (inside this issue) -->
    {featureList && featureList.items && featureList.items.length > 0 && (
      <div class="cover__features">
        <div class="cover__features-header">
          <span>{featureList.heading ?? "Inside"}</span>
        </div>
        <ul class="cover__features-list">
          {featureList.items.map((item: CoverFeatureItem) => (
            <li>
              <span class="cover__feature-no">{item.no}</span>
              <span class="cover__feature-text">{item.text}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Footer: Barcode + CTA -->
    <footer class="cover__footer">
      {barcode && <div class="cover__barcode" />}
      {cta && <span class="cover__cta">{cta.text}</span>}
    </footer>
  </div>

  <!-- Sticker overlay -->
  {sticker && (
    <div class="cover__sticker">
      <span class="cover__sticker-big">{sticker.big}</span>
      {sticker.small && <span class="cover__sticker-small">{sticker.small}</span>}
    </div>
  )}

  <!-- Corner fold effect -->
  <div class="cover__fold" aria-hidden="true" />
</WrapperTag>

---
import type { CollectionEntry } from 'astro:content';

interface Props {
  issue: CollectionEntry<'issues'>;
  publication: CollectionEntry<'publications'>;
  coverLines: string[];
  showStatus?: boolean;
}

const palettes: Record<string, { accent: string; ink: string; overlay: string; glow: string }> = {
  'red-ops': {
    accent: '#f59f85',
    ink: '#fff5ef',
    overlay: 'linear-gradient(160deg, rgba(0,0,0,0.72) 0%, rgba(18,6,10,0.72) 50%, rgba(18,6,10,0.5) 100%)',
    glow: 'rgba(245,159,133,0.35)',
  },
  'field-guide': {
    accent: '#71ead5',
    ink: '#eafffb',
    overlay: 'linear-gradient(160deg, rgba(0,0,0,0.7) 0%, rgba(10,32,28,0.7) 50%, rgba(10,32,28,0.45) 100%)',
    glow: 'rgba(113,234,213,0.3)',
  },
};

const { issue, publication, coverLines, showStatus = false } = Astro.props;
const badge = `Vol ${issue.data.volume} / No ${issue.data.number}`;
const date = new Date(issue.data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
const palette = palettes[publication.id] ?? {
  accent: publication.data.accent ?? 'var(--accent)',
  ink: 'var(--ink)',
  overlay: 'linear-gradient(160deg, rgba(0,0,0,0.72), rgba(0,0,0,0.5))',
  glow: 'rgba(246,195,92,0.28)',
};
const featureLine = coverLines[0] ?? issue.data.theme;
const insideLines = coverLines.length > 0 ? coverLines.slice(0, 3) : [issue.data.theme, issue.data.notesFromEditor].filter(Boolean);
const statusLabel = showStatus ? (issue.data.status ?? 'New') : 'Featured';
const coverArt: Record<string, string> = {
  'red-ops:vol-1-debugging': 'https://images.unsplash.com/photo-1527437934671-61474b530017?auto=format&fit=crop&w=1100&q=80',
  'red-ops:vol-1-incident-patterns': 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1100&q=80',
  'red-ops:vol-0-preflight': 'https://images.unsplash.com/photo-1504384764586-bb4cdc1707b0?auto=format&fit=crop&w=1100&q=80',
  'field-guide:makers-overland': 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1100&q=80',
  'field-guide:trail-circuits': 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1100&q=80',
  'field-guide:night-maps': 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1100&q=80',
};
const artKey = `${publication.id}:${issue.data.issueSlug}`;
const artUrl = coverArt[artKey] ?? coverArt[publication.id] ?? 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=900&q=80';
---
<a
  href={`/issues/${issue.data.publicationId}/${issue.data.issueSlug}`}
  class="cover-card group relative block h-full overflow-hidden focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"
  style={`--accent:${palette.accent};--cover-ink:${palette.ink};--cover-overlay:${palette.overlay};--cover-glow:${palette.glow};`}
  data-pub={publication.id}
>
  <div class="texture pointer-events-none absolute inset-0"></div>
  <div class="relative flex h-full flex-col">
    <div class="cover-top">
      <span class="cover-label">{publication.data.name}</span>
      <span class="cover-badge">
        <span class="h-2 w-2 rounded-full bg-[var(--accent)]"></span>
        {statusLabel}
      </span>
    </div>
    <div class="cover-photo" style={`background-image:url(${artUrl});`}>
      <div class="cover-content" style={`background:${palette.overlay}`}>
        <div class="cover-kicker">{badge}</div>
        <h3 class="cover-title">{issue.data.displayTitle}</h3>
        <p class="cover-subline">{featureLine}</p>
      </div>
    </div>
    <div class="cover-inside">
      <div class="inside-title">
        <span>Inside</span>
        <span>{date}</span>
      </div>
      <ul class="inside-list">
        {insideLines.map((line, idx) => (
          <li class="inside-item">
            <span class="inside-number">{idx + 1}</span>
            <span class="font-display leading-tight text-[var(--cover-ink)]">{line}</span>
          </li>
        ))}
      </ul>
    </div>
    <div class="cover-meta">
      <span class="font-mono">{issue.data.theme}</span>
      <span class="pill">Pick up</span>
    </div>
  </div>
</a>

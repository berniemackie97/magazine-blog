---
interface FilterOption {
  label: string;
  value: string;
}

interface Props {
  publications: FilterOption[];
  sections: FilterOption[];
  formats: FilterOption[];
  difficulties: FilterOption[];
  tags: FilterOption[];
}

const { publications, sections, formats, difficulties, tags } = Astro.props;
---
<form class="mb-6 grid gap-3 rounded-xl border border-[var(--rule)] bg-[var(--paper-2)]/90 p-4 shadow-paper md:grid-cols-5" id="filters">
  <label class="text-xs font-semibold uppercase tracking-[0.16em] text-[var(--muted)]">
    Publication
    <select
      class="mt-1 w-full rounded-md border border-[var(--rule)] bg-[var(--paper-3)]/80 p-2 text-sm focus:border-[var(--accent)] focus:outline-none"
      name="publication"
    >
      <option value="">All</option>
      {publications.map((publication) => (
        <option value={publication.value}>{publication.label}</option>
      ))}
    </select>
  </label>
  <label class="text-xs font-semibold uppercase tracking-[0.16em] text-[var(--muted)]">
    Section
    <select
      class="mt-1 w-full rounded-md border border-[var(--rule)] bg-[var(--paper-3)]/80 p-2 text-sm focus:border-[var(--accent)] focus:outline-none"
      name="section"
    >
      <option value="">All</option>
      {sections.map((section) => (
        <option value={section.value}>{section.label}</option>
      ))}
    </select>
  </label>
  <label class="text-xs font-semibold uppercase tracking-[0.16em] text-[var(--muted)]">
    Format
    <select
      class="mt-1 w-full rounded-md border border-[var(--rule)] bg-[var(--paper-3)]/80 p-2 text-sm focus:border-[var(--accent)] focus:outline-none"
      name="format"
    >
      <option value="">All</option>
      {formats.map((format) => (
        <option value={format.value}>{format.label}</option>
      ))}
    </select>
  </label>
  <label class="text-xs font-semibold uppercase tracking-[0.16em] text-[var(--muted)]">
    Difficulty
    <select
      class="mt-1 w-full rounded-md border border-[var(--rule)] bg-[var(--paper-3)]/80 p-2 text-sm focus:border-[var(--accent)] focus:outline-none"
      name="difficulty"
    >
      <option value="">All</option>
      {difficulties.map((difficulty) => (
        <option value={difficulty.value}>{difficulty.label}</option>
      ))}
    </select>
  </label>
  <label class="text-xs font-semibold uppercase tracking-[0.16em] text-[var(--muted)]">
    Tag
    <select
      class="mt-1 w-full rounded-md border border-[var(--rule)] bg-[var(--paper-3)]/80 p-2 text-sm focus:border-[var(--accent)] focus:outline-none"
      name="tag"
    >
      <option value="">All</option>
      {tags.map((tag) => (
        <option value={tag.value}>{tag.label}</option>
      ))}
    </select>
  </label>
</form>

<script is:inline>
  const form = document.querySelector('#filters');
  const items = Array.from(document.querySelectorAll('[data-filter-item]'));

  if (form instanceof HTMLFormElement) {
    form.addEventListener('input', () => {
      const data = new FormData(form);
      const filters = {
        publication: data.get('publication')?.toString() ?? '',
        section: data.get('section')?.toString() ?? '',
        format: data.get('format')?.toString() ?? '',
        difficulty: data.get('difficulty')?.toString() ?? '',
        tag: data.get('tag')?.toString() ?? '',
      };

      items.forEach((item) => {
        if (!(item instanceof HTMLElement)) return;
        const matches =
          (!filters.publication || item.dataset.publication === filters.publication) &&
          (!filters.section || item.dataset.section === filters.section) &&
          (!filters.format || item.dataset.format === filters.format) &&
          (!filters.difficulty || item.dataset.difficulty === filters.difficulty) &&
          (!filters.tag || (item.dataset.tags ?? '').split(',').includes(filters.tag));
        item.toggleAttribute('hidden', !matches);
      });
    });
  }
</script>
